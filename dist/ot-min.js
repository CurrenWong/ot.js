/*
 *    /\
 *   /  \ @curren/ot 0.0.18
 *  /    \ http://operational-transformation.github.com
 *  \    /
 *   \  / (c) 2012-2020 Maintainer : Curren Wong <curren_wong@163.com> , Creater : Tim Baumann <tim@timbaumann.info> (http://timbaumann.info)
 *    \/ @curren/ot may be freely distributed under the MIT license.
 */


void 0===ot&&(ot={}),ot.TextOperation=function(){"use strict";function u(){if(!this||this.constructor!==u)return new u;this.ops=[],this.baseLength=0,this.targetLength=0}u.prototype.equals=function(t){if(this.baseLength!==t.baseLength)return!1;if(this.targetLength!==t.targetLength)return!1;if(this.ops.length!==t.ops.length)return!1;for(var e=0;e<this.ops.length;e++)if(this.ops[e]!==t.ops[e])return!1;return!0};var l=u.isRetain=function(t){return"number"==typeof t&&0<t},f=u.isInsert=function(t){return"string"==typeof t},d=u.isDelete=function(t){return"number"==typeof t&&t<0};function r(t){var e=t.ops,o=u.isRetain;switch(e.length){case 1:return e[0];case 2:return o(e[0])?e[1]:o(e[1])?e[0]:null;case 3:if(o(e[0])&&o(e[2]))return e[1]}return null}function s(t){return l(t.ops[0])?t.ops[0]:0}return u.prototype.retain=function(t){if("number"!=typeof t)throw new Error("retain expects an integer");return 0===t||(this.baseLength+=t,this.targetLength+=t,l(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=t:this.ops.push(t)),this},u.prototype.insert=function(t){if("string"!=typeof t)throw new Error("insert expects a string");if(""===t)return this;this.targetLength+=t.length;var e=this.ops;return f(e[e.length-1])?e[e.length-1]+=t:d(e[e.length-1])?f(e[e.length-2])?e[e.length-2]+=t:(e[e.length]=e[e.length-1],e[e.length-2]=t):e.push(t),this},u.prototype.delete=function(t){if("string"==typeof t&&(t=t.length),"number"!=typeof t)throw new Error("delete expects an integer or a string");return 0===t||(0<t&&(t=-t),this.baseLength-=t,d(this.ops[this.ops.length-1])?this.ops[this.ops.length-1]+=t:this.ops.push(t)),this},u.prototype.isNoop=function(){return 0===this.ops.length||1===this.ops.length&&l(this.ops[0])},u.prototype.toString=function(){return(Array.prototype.map||function(t){for(var e=[],o=0,n=this.length;o<n;o++)e[o]=t(this[o]);return e}).call(this.ops,function(t){return l(t)?"retain "+t:f(t)?"insert '"+t+"'":"delete "+-t}).join(", ")},u.prototype.toJSON=function(){return this.ops},u.fromJSON=function(t){for(var e=new u,o=0,n=t.length;o<n;o++){var i=t[o];if(l(i))e.retain(i);else if(f(i))e.insert(i);else{if(!d(i))throw new Error("unknown operation: "+JSON.stringify(i));e.delete(i)}}return e},u.prototype.apply=function(t){if(t.length!==this.baseLength)throw new Error("The operation's base length must be equal to the string's length.");for(var e=[],o=0,n=0,i=this.ops,r=0,s=i.length;r<s;r++){var p=i[r];if(l(p)){if(n+p>t.length)throw new Error("Operation can't retain more characters than are left in the string.");e[o++]=t.slice(n,n+p),n+=p}else f(p)?e[o++]=p:n-=p}if(n!==t.length)throw new Error("The operation didn't operate on the whole string.");return e.join("")},u.prototype.invert=function(t){for(var e=0,o=new u,n=this.ops,i=0,r=n.length;i<r;i++){var s=n[i];l(s)?(o.retain(s),e+=s):f(s)?o.delete(s.length):(o.insert(t.slice(e,e-s)),e-=s)}return o},u.prototype.compose=function(t){if(this.targetLength!==t.baseLength)throw new Error("The base length of the second operation has to be the target length of the first operation");for(var e=new u,o=this.ops,n=t.ops,i=0,r=0,s=o[i++],p=n[r++];void 0!==s||void 0!==p;)if(d(s))e.delete(s),s=o[i++];else if(f(p))e.insert(p),p=n[r++];else{if(void 0===s)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===p)throw new Error("Cannot compose operations: first operation is too long.");if(l(s)&&l(p))p<s?(e.retain(p),s-=p,p=n[r++]):s===p?(e.retain(s),s=o[i++],p=n[r++]):(e.retain(s),p-=s,s=o[i++]);else if(f(s)&&d(p))s.length>-p?(s=s.slice(-p),p=n[r++]):s.length===-p?(s=o[i++],p=n[r++]):(p+=s.length,s=o[i++]);else if(f(s)&&l(p))s.length>p?(e.insert(s.slice(0,p)),s=s.slice(p),p=n[r++]):s.length===p?(e.insert(s),s=o[i++],p=n[r++]):(e.insert(s),p-=s.length,s=o[i++]);else{if(!l(s)||!d(p))throw new Error("This shouldn't happen: op1: "+JSON.stringify(s)+", op2: "+JSON.stringify(p));-p<s?(e.delete(p),s+=p,p=n[r++]):s===-p?(e.delete(p),s=o[i++],p=n[r++]):(e.delete(s),p+=s,s=o[i++])}}return e},u.prototype.shouldBeComposedWith=function(t){if(this.isNoop()||t.isNoop())return!0;var e=s(this),o=s(t),n=r(this),i=r(t);return!(!n||!i)&&(f(n)&&f(i)?e+n.length===o:!(!d(n)||!d(i))&&(o-i===e||e===o))},u.prototype.shouldBeComposedWithInverted=function(t){if(this.isNoop()||t.isNoop())return!0;var e=s(this),o=s(t),n=r(this),i=r(t);return!(!n||!i)&&(f(n)&&f(i)?e+n.length===o||e===o:!(!d(n)||!d(i))&&o-i===e)},u.transform=function(t,e){if(t.baseLength!==e.baseLength)throw new Error("Both operations have to have the same base length");for(var o,n=new u,i=new u,r=t.ops,s=e.ops,p=0,a=0,c=r[p++],h=s[a++];void 0!==c||void 0!==h;)if(f(c))n.insert(c),i.retain(c.length),c=r[p++];else if(f(h))n.retain(h.length),i.insert(h),h=s[a++];else{if(void 0===c)throw new Error("Cannot compose operations: first operation is too short.");if(void 0===h)throw new Error("Cannot compose operations: first operation is too long.");if(l(c)&&l(h))h<c?(c-=o=h,h=s[a++]):c===h?(o=h,c=r[p++],h=s[a++]):(h-=o=c,c=r[p++]),n.retain(o),i.retain(o);else if(d(c)&&d(h))-h<-c?(c-=h,h=s[a++]):c===h?(c=r[p++],h=s[a++]):(h-=c,c=r[p++]);else if(d(c)&&l(h))h<-c?(c+=o=h,h=s[a++]):-c===h?(o=h,c=r[p++],h=s[a++]):(o=-c,h+=c,c=r[p++]),n.delete(o);else{if(!l(c)||!d(h))throw new Error("The two operations aren't compatible");-h<c?(o=-h,c+=h,h=s[a++]):c===-h?(o=c,c=r[p++],h=s[a++]):(h+=o=c,c=r[p++]),i.delete(o)}}return[n,i]},u}(),"object"==typeof module&&(module.exports=ot.TextOperation),void 0===ot&&(ot={}),ot.Selection=function(t){"use strict";var s=t.ot?t.ot.TextOperation:require("./text-operation");function i(t,e){this.anchor=t,this.head=e}function r(t){this.ranges=t||[]}return i.fromJSON=function(t){return new i(t.anchor,t.head)},i.prototype.equals=function(t){return this.anchor===t.anchor&&this.head===t.head},i.prototype.isEmpty=function(){return this.anchor===this.head},i.prototype.transform=function(r){function t(t){for(var e=t,o=r.ops,n=0,i=r.ops.length;n<i&&(s.isRetain(o[n])?t-=o[n]:s.isInsert(o[n])?e+=o[n].length:(e-=Math.min(t,-o[n]),t+=o[n]),!(t<0));n++);return e}var e=t(this.anchor);return this.anchor===this.head?new i(e,e):new i(e,t(this.head))},r.Range=i,r.createCursor=function(t){return new r([new i(t,t)])},r.fromJSON=function(t){for(var e=t.ranges||t,o=0,n=[];o<e.length;o++)n[o]=i.fromJSON(e[o]);return new r(n)},r.prototype.equals=function(t){if(this.position!==t.position)return!1;if(this.ranges.length!==t.ranges.length)return!1;for(var e=0;e<this.ranges.length;e++)if(!this.ranges[e].equals(t.ranges[e]))return!1;return!0},r.prototype.somethingSelected=function(){for(var t=0;t<this.ranges.length;t++)if(!this.ranges[t].isEmpty())return!0;return!1},r.prototype.compose=function(t){return t},r.prototype.transform=function(t){for(var e=0,o=[];e<this.ranges.length;e++)o[e]=this.ranges[e].transform(t);return new r(o)},r}(this),"object"==typeof module&&(module.exports=ot.Selection),void 0===ot&&(ot={}),ot.WrappedOperation=function(){"use strict";function n(t,e){this.wrapped=t,this.meta=e}function i(t,e){for(var o in t)t.hasOwnProperty(o)&&(e[o]=t[o])}function r(t,e){return t&&"object"==typeof t&&"function"==typeof t.transform?t.transform(e):t}return n.prototype.apply=function(){return this.wrapped.apply.apply(this.wrapped,arguments)},n.prototype.invert=function(){var t=this.meta;return new n(this.wrapped.invert.apply(this.wrapped,arguments),t&&"object"==typeof t&&"function"==typeof t.invert?t.invert.apply(t,arguments):t)},n.prototype.compose=function(t){return new n(this.wrapped.compose(t.wrapped),function(t,e){if(t&&"object"==typeof t){if("function"==typeof t.compose)return t.compose(e);var o={};return i(t,o),i(e,o),o}return e}(this.meta,t.meta))},n.transform=function(t,e){var o=(0,t.wrapped.constructor.transform)(t.wrapped,e.wrapped);return[new n(o[0],r(t.meta,e.wrapped)),new n(o[1],r(e.meta,t.wrapped))]},n}(),"object"==typeof module&&(module.exports=ot.WrappedOperation),void 0===ot&&(ot={}),ot.UndoManager=function(){"use strict";var e="normal",n="undoing",i="redoing";function t(t){this.maxItems=t||50,this.state=e,this.dontCompose=!1,this.undoStack=[],this.redoStack=[]}function o(t,e){for(var o=[],n=e.constructor,i=t.length-1;0<=i;i--){var r=n.transform(t[i],e);"function"==typeof r[0].isNoop&&r[0].isNoop()||o.push(r[0]),e=r[1]}return o.reverse()}return t.prototype.add=function(t,e){var o;this.state===n?(this.redoStack.push(t),this.dontCompose=!0):this.state===i?(this.undoStack.push(t),this.dontCompose=!0):(o=this.undoStack,!this.dontCompose&&e&&0<o.length?o.push(t.compose(o.pop())):(o.push(t),o.length>this.maxItems&&o.shift()),this.dontCompose=!1,this.redoStack=[])},t.prototype.transform=function(t){this.undoStack=o(this.undoStack,t),this.redoStack=o(this.redoStack,t)},t.prototype.performUndo=function(t){if(this.state=n,0===this.undoStack.length)throw new Error("undo not possible");t(this.undoStack.pop()),this.state=e},t.prototype.performRedo=function(t){if(this.state=i,0===this.redoStack.length)throw new Error("redo not possible");t(this.redoStack.pop()),this.state=e},t.prototype.canUndo=function(){return 0!==this.undoStack.length},t.prototype.canRedo=function(){return 0!==this.redoStack.length},t.prototype.isUndoing=function(){return this.state===n},t.prototype.isRedoing=function(){return this.state===i},t}(),"object"==typeof module&&(module.exports=ot.UndoManager),void 0===ot&&(ot={}),ot.Client=function(){"use strict";function t(t){this.revision=t,this.state=o}function e(){}t.prototype.setState=function(t){this.state=t},t.prototype.applyClient=function(t){this.setState(this.state.applyClient(this,t))},t.prototype.applyServer=function(t){this.revision++,this.setState(this.state.applyServer(this,t))},t.prototype.serverAck=function(){this.revision++,this.setState(this.state.serverAck(this))},t.prototype.serverReconnect=function(){"function"==typeof this.state.resend&&this.state.resend(this)},t.prototype.transformSelection=function(t){return this.state.transformSelection(t)},t.prototype.sendOperation=function(t,e){throw new Error("sendOperation must be defined in child class")},t.prototype.applyOperation=function(t){throw new Error("applyOperation must be defined in child class")},(t.Synchronized=e).prototype.applyClient=function(t,e){return t.sendOperation(t.revision,e),new n(e)},e.prototype.applyServer=function(t,e){return t.applyOperation(e),this},e.prototype.serverAck=function(t){throw new Error("There is no pending operation.")},e.prototype.transformSelection=function(t){return t};var o=new e;function n(t){this.outstanding=t}function r(t,e){this.outstanding=t,this.buffer=e}return(t.AwaitingConfirm=n).prototype.applyClient=function(t,e){return new r(this.outstanding,e)},n.prototype.applyServer=function(t,e){var o=e.constructor.transform(this.outstanding,e);return t.applyOperation(o[1]),new n(o[0])},n.prototype.serverAck=function(t){return o},n.prototype.transformSelection=function(t){return t.transform(this.outstanding)},n.prototype.resend=function(t){t.sendOperation(t.revision,this.outstanding)},(t.AwaitingWithBuffer=r).prototype.applyClient=function(t,e){var o=this.buffer.compose(e);return new r(this.outstanding,o)},r.prototype.applyServer=function(t,e){var o=e.constructor.transform,n=o(this.outstanding,e),i=o(this.buffer,n[1]);return t.applyOperation(i[1]),new r(n[0],i[0])},r.prototype.serverAck=function(t){return t.sendOperation(t.revision,this.buffer),new n(this.buffer)},r.prototype.transformSelection=function(t){return t.transform(this.outstanding).transform(this.buffer)},r.prototype.resend=function(t){t.sendOperation(t.revision,this.outstanding)},t}(),"object"==typeof module&&(module.exports=ot.Client),ot.CodeMirrorAdapter=function(){"use strict";var l=ot.TextOperation,i=ot.Selection;function n(t){this.cm=t,this.ignoreNextChange=!1,this.changeInProgress=!1,this.selectionChanged=!1,e(this,"onChanges"),e(this,"onChange"),e(this,"onCursorActivity"),e(this,"onFocus"),e(this,"onBlur"),t.on("changes",this.onChanges),t.on("change",this.onChange),t.on("cursorActivity",this.onCursorActivity),t.on("focus",this.onFocus),t.on("blur",this.onBlur)}function o(t,e){return t.line<e.line?-1:t.line>e.line?1:t.ch<e.ch?-1:t.ch>e.ch?1:0}function f(t,e){return o(t,e)<=0}n.prototype.detach=function(){this.cm.off("changes",this.onChanges),this.cm.off("change",this.onChange),this.cm.off("cursorActivity",this.onCursorActivity),this.cm.off("focus",this.onFocus),this.cm.off("blur",this.onBlur)},n.operationFromCodeMirrorChange=n.operationFromCodeMirrorChanges=function(t,e){var o,n=(o=e).indexFromPos({line:o.lastLine(),ch:0})+o.getLine(o.lastLine()).length,i=(new l).retain(n),r=(new l).retain(n),s=function(t){return e.indexFromPos(t)};function p(t){if(0===t.length)return 0;for(var e=0,o=0;o<t.length;o++)e+=t[o].length;return e+t.length-1}for(var a=t.length-1;0<=a;a--){var c=t[a],h=(s=function(o,n){return function(t){return f(t,n.from)?o(t):f(n.to,t)?o({line:t.line+n.text.length-1-(n.to.line-n.from.line),ch:n.to.line<t.line?t.ch:n.text.length<=1?t.ch-(n.to.ch-n.from.ch)+p(n.text):t.ch-n.to.ch+(e=n.text)[e.length-1].length})+p(n.removed)-p(n.text):n.from.line===t.line?o(n.from)+t.ch-n.from.ch:o(n.from)+p(n.removed.slice(0,t.line-n.from.line))+1+t.ch;var e}}(s,c))(c.from),u=n-h-p(c.text),i=(new l).retain(h).delete(p(c.removed)).insert(c.text.join("\n")).retain(u).compose(i),r=r.compose((new l).retain(h).delete(p(c.text)).insert(c.removed.join("\n")).retain(u));n+=p(c.removed)-p(c.text)}return[i,r]},n.applyOperationToCodeMirror=function(p,a){a.operation(function(){for(var t=p.ops,e=0,o=0,n=t.length;o<n;o++){var i,r,s=t[o];l.isRetain(s)?e+=s:l.isInsert(s)?(a.replaceRange(s,a.posFromIndex(e)),e+=s.length):l.isDelete(s)&&(i=a.posFromIndex(e),r=a.posFromIndex(e-s),a.replaceRange("",i,r))}})},n.prototype.registerCallbacks=function(t){this.callbacks=t},n.prototype.onChange=function(){this.changeInProgress=!0},n.prototype.onChanges=function(t,e){var o;this.ignoreNextChange||(o=n.operationFromCodeMirrorChanges(e,this.cm),this.trigger("change",o[0],o[1])),this.selectionChanged&&this.trigger("selectionChange"),this.changeInProgress=!1,this.ignoreNextChange=!1},n.prototype.onCursorActivity=n.prototype.onFocus=function(){this.changeInProgress?this.selectionChanged=!0:this.trigger("selectionChange")},n.prototype.onBlur=function(){this.cm.somethingSelected()||this.trigger("blur")},n.prototype.getValue=function(){return this.cm.getValue()},n.prototype.getSelection=function(){for(var t=this.cm,e=t.listSelections(),o=[],n=0;n<e.length;n++)o[n]=new i.Range(t.indexFromPos(e[n].anchor),t.indexFromPos(e[n].head));return new i(o)},n.prototype.setSelection=function(t){for(var e=[],o=0;o<t.ranges.length;o++){var n=t.ranges[o];e[o]={anchor:this.cm.posFromIndex(n.anchor),head:this.cm.posFromIndex(n.head)}}this.cm.setSelections(e)};var u=function(){var e={},t=document.createElement("style");document.documentElement.getElementsByTagName("head")[0].appendChild(t);var o=t.sheet;return function(t){e[t]||(e[t]=!0,o.insertRule(t,(o.cssRules||o.rules).length))}}();function e(t,e){var o=t[e];t[e]=function(){o.apply(t,arguments)}}return n.prototype.setOtherCursor=function(t,e,o){var n=this.cm.posFromIndex(t),i=this.cm.cursorCoords(n),r=document.createElement("span");return r.className="other-client",r.style.display="inline-block",r.style.padding="0",r.style.marginLeft=r.style.marginRight="-1px",r.style.borderLeftWidth="2px",r.style.borderLeftStyle="solid",r.style.borderLeftColor=e,r.style.height=.9*(i.bottom-i.top)+"px",r.style.zIndex=0,r.setAttribute("data-clientid",o),this.cm.setBookmark(n,{widget:r,insertLeft:!0})},n.prototype.setOtherSelectionRange=function(t,e,o){var n=/^#([0-9a-fA-F]{6})$/.exec(e);if(!n)throw new Error("only six-digit hex colors are allowed.");var i="selection-"+n[1];u("."+i+" { background: "+e+"; }");var r,s,p,a,c=this.cm.posFromIndex(t.anchor),h=this.cm.posFromIndex(t.head);return this.cm.markText(f(p=c,a=h)?p:a,f(r=c,s=h)?s:r,{className:i})},n.prototype.setOtherSelection=function(t,e,o){for(var n=[],i=0;i<t.ranges.length;i++){var r=t.ranges[i];r.isEmpty()?n[i]=this.setOtherCursor(r.head,e,o):n[i]=this.setOtherSelectionRange(r,e,o)}return{clear:function(){for(var t=0;t<n.length;t++)n[t].clear()}}},n.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),o=this.callbacks&&this.callbacks[t];o&&o.apply(this,e)},n.prototype.applyOperation=function(t){this.ignoreNextChange=!0,n.applyOperationToCodeMirror(t,this.cm)},n.prototype.registerUndo=function(t){this.cm.undo=t},n.prototype.registerRedo=function(t){this.cm.redo=t},n}(),ot.SocketIOAdapter=function(){"use strict";function t(t){this.socket=t;var n=this;t.on("client_left",function(t){n.trigger("client_left",t)}).on("set_name",function(t,e){n.trigger("set_name",t,e)}).on("ack",function(){n.trigger("ack")}).on("operation",function(t,e,o){n.trigger("operation",e),n.trigger("selection",t,o)}).on("selection",function(t,e){n.trigger("selection",t,e)}).on("reconnect",function(){n.trigger("reconnect")})}return t.prototype.sendOperation=function(t,e,o){this.socket.emit("operation",t,e,o)},t.prototype.sendSelection=function(t){this.socket.emit("selection",t)},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),o=this.callbacks&&this.callbacks[t];o&&o.apply(this,e)},t}(),ot.AjaxAdapter=function(){"use strict";function t(t,e,o){"/"!==t[t.length-1]&&(t+="/"),this.path=t,this.ownUserName=e,this.majorRevision=o.major||0,this.minorRevision=o.minor||0,this.poll()}return t.prototype.renderRevisionPath=function(){return"revision/"+this.majorRevision+"-"+this.minorRevision},t.prototype.handleResponse=function(t){for(var e=t.operations,o=0;o<e.length;o++)e[o].user===this.ownUserName?this.trigger("ack"):this.trigger("operation",e[o].operation);0<e.length&&(this.majorRevision+=e.length,this.minorRevision=0);var n=t.events;if(n){for(o=0;o<n.length;o++){var i=n[o].user;if(i!==this.ownUserName)switch(n[o].event){case"joined":this.trigger("set_name",i,i);break;case"left":this.trigger("client_left",i);break;case"selection":this.trigger("selection",i,n[o].selection)}}this.minorRevision+=n.length}var r=t.users;r&&(delete r[this.ownUserName],this.trigger("clients",r)),t.revision&&(this.majorRevision=t.revision.major,this.minorRevision=t.revision.minor)},t.prototype.poll=function(){var e=this;$.ajax({url:this.path+this.renderRevisionPath(),type:"GET",dataType:"json",timeout:5e3,success:function(t){e.handleResponse(t),e.poll()},error:function(){setTimeout(function(){e.poll()},500)}})},t.prototype.sendOperation=function(t,e,o){if(t!==this.majorRevision)throw new Error("Revision numbers out of sync");var n=this;$.ajax({url:this.path+this.renderRevisionPath(),type:"POST",data:JSON.stringify({operation:e,selection:o}),contentType:"application/json",processData:!1,success:function(t){},error:function(){setTimeout(function(){n.sendOperation(t,e,o)},500)}})},t.prototype.sendSelection=function(t){$.ajax({url:this.path+this.renderRevisionPath()+"/selection",type:"POST",data:JSON.stringify(t),contentType:"application/json",processData:!1,timeout:1e3})},t.prototype.registerCallbacks=function(t){this.callbacks=t},t.prototype.trigger=function(t){var e=Array.prototype.slice.call(arguments,1),o=this.callbacks&&this.callbacks[t];o&&o.apply(this,e)},t}(),ot.EditorClient=function(){"use strict";var t,r=ot.Client,s=ot.Selection,p=ot.UndoManager,a=ot.TextOperation,c=ot.WrappedOperation;function h(t,e){this.selectionBefore=t,this.selectionAfter=e}function o(t,e,o,n,i){this.id=t,this.listEl=e,this.editorAdapter=o,this.name=n,this.li=document.createElement("li"),n&&(this.li.textContent=n,this.listEl.appendChild(this.li)),this.setColor(n?l(n):Math.random()),i&&this.updateSelection(i)}function e(t,e,o,n){r.call(this,t),this.serverAdapter=o,this.editorAdapter=n,this.undoManager=new p,this.initializeClientList(),this.initializeClients(e);var i=this;this.editorAdapter.registerCallbacks({change:function(t,e){i.onChange(t,e)},selectionChange:function(){i.onSelectionChange()},blur:function(){i.onBlur()}}),this.editorAdapter.registerUndo(function(){i.undo()}),this.editorAdapter.registerRedo(function(){i.redo()}),this.serverAdapter.registerCallbacks({client_left:function(t){i.onClientLeft(t)},set_name:function(t,e){i.getClientObject(t).setName(e)},ack:function(){i.serverAck()},operation:function(t){i.applyServer(a.fromJSON(t))},selection:function(t,e){e?i.getClientObject(t).updateSelection(i.transformSelection(s.fromJSON(e))):i.getClientObject(t).removeSelection()},clients:function(t){var e,o,n;for(e in i.clients)i.clients.hasOwnProperty(e)&&!t.hasOwnProperty(e)&&i.onClientLeft(e);for(e in t){t.hasOwnProperty(e)&&(o=i.getClientObject(e),t[e].name&&o.setName(t[e].name),(n=t[e].selection)?i.clients[e].updateSelection(i.transformSelection(s.fromJSON(n))):i.clients[e].removeSelection())}},reconnect:function(){i.serverReconnect()}})}function n(){}function u(t,e,o){function n(t){var e=Math.round(255*t).toString(16);return 1===e.length?"0"+e:e}return"#"+n(t)+n(e)+n(o)}function i(t,e,o){if(0===e)return u(o,o,o);function n(t){return t<0&&(t+=1),1<t&&--t,6*t<1?r+6*(i-r)*t:2*t<1?i:3*t<2?r+6*(i-r)*(2/3-t):r}var i=o<.5?o*(1+e):o+e-e*o,r=2*o-i;return u(n(t+1/3),n(t),n(t-1/3))}function l(t){for(var e=1,o=0;o<t.length;o++)e=17*(e+t.charCodeAt(o))%360;return e/360}return h.prototype.invert=function(){return new h(this.selectionAfter,this.selectionBefore)},h.prototype.compose=function(t){return new h(this.selectionBefore,t.selectionAfter)},h.prototype.transform=function(t){return new h(this.selectionBefore.transform(t),this.selectionAfter.transform(t))},o.prototype.setColor=function(t){this.hue=t,this.color=i(t,.75,.5),this.lightColor=i(t,.5,.9),this.li&&(this.li.style.color=this.color)},o.prototype.setName=function(t){this.name!==t&&(this.name=t,this.li.textContent=t,this.li.parentNode||this.listEl.appendChild(this.li),this.setColor(l(t)))},o.prototype.updateSelection=function(t){this.removeSelection(),this.selection=t,this.mark=this.editorAdapter.setOtherSelection(t,t.position===t.selectionEnd?this.color:this.lightColor,this.id)},o.prototype.remove=function(){var t;this.li&&(t=this.li).parentNode&&t.parentNode.removeChild(t),this.removeSelection()},o.prototype.removeSelection=function(){this.mark&&(this.mark.clear(),this.mark=null)},t=e,n.prototype=r.prototype,t.prototype=new n,t.prototype.constructor=t,e.prototype.addClient=function(t,e){this.clients[t]=new o(t,this.clientListEl,this.editorAdapter,e.name||t,e.selection?s.fromJSON(e.selection):null)},e.prototype.initializeClients=function(t){for(var e in this.clients={},t)t.hasOwnProperty(e)&&this.addClient(e,t[e])},e.prototype.getClientObject=function(t){var e=this.clients[t];return e||(this.clients[t]=new o(t,this.clientListEl,this.editorAdapter))},e.prototype.onClientLeft=function(t){console.log("User disconnected: "+t);var e=this.clients[t];e&&(e.remove(),delete this.clients[t])},e.prototype.initializeClientList=function(){this.clientListEl=document.createElement("ul")},e.prototype.applyUnredo=function(t){this.undoManager.add(t.invert(this.editorAdapter.getValue())),this.editorAdapter.applyOperation(t.wrapped),this.selection=t.meta.selectionAfter,this.editorAdapter.setSelection(this.selection),this.applyClient(t.wrapped)},e.prototype.undo=function(){var e=this;this.undoManager.canUndo()&&this.undoManager.performUndo(function(t){e.applyUnredo(t)})},e.prototype.redo=function(){var e=this;this.undoManager.canRedo()&&this.undoManager.performRedo(function(t){e.applyUnredo(t)})},e.prototype.onChange=function(t,e){var o=this.selection;this.updateSelection();var n,i=new h(o,this.selection),r=(new c(t,i),0<this.undoManager.undoStack.length&&e.shouldBeComposedWithInverted((n=this.undoManager.undoStack)[n.length-1].wrapped)),s=new h(this.selection,o);this.undoManager.add(new c(e,s),r),this.applyClient(t)},e.prototype.updateSelection=function(){this.selection=this.editorAdapter.getSelection()},e.prototype.onSelectionChange=function(){var t=this.selection;this.updateSelection(),t&&this.selection.equals(t)||this.sendSelection(this.selection)},e.prototype.onBlur=function(){this.selection=null,this.sendSelection(null)},e.prototype.sendSelection=function(t){this.state instanceof r.AwaitingWithBuffer||this.serverAdapter.sendSelection(t)},e.prototype.sendOperation=function(t,e){this.serverAdapter.sendOperation(t,e.toJSON(),this.selection)},e.prototype.applyOperation=function(t){this.editorAdapter.applyOperation(t),this.updateSelection(),this.undoManager.transform(new c(t,null))},e}();var ot,EventEmitter=require("events").EventEmitter,TextOperation=require("./text-operation"),WrappedOperation=require("./wrapped-operation"),Server=require("./server"),Selection=require("./selection"),util=require("util");function EditorSocketIOServer(t,e,o,n){EventEmitter.call(this),Server.call(this,t,e),this.users={},this.docId=o,this.mayWrite=n||function(t,e){e(!0)}}function extend(t,e){for(var o in e)e.hasOwnProperty(o)&&(t[o]=e[o])}util.inherits(EditorSocketIOServer,Server),extend(EditorSocketIOServer.prototype,EventEmitter.prototype),EditorSocketIOServer.prototype.addClient=function(i){var r=this;i.join(this.docId).emit("doc",{str:this.document,revision:this.operations.length,clients:this.users}).on("operation",function(e,o,n){r.mayWrite(i,function(t){t?r.onOperation(i,e,o,n):console.log("User doesn't have the right to edit.")})}).on("selection",function(e){r.mayWrite(i,function(t){t?r.updateSelection(i,e&&Selection.fromJSON(e)):console.log("User doesn't have the right to edit.")})}).on("disconnect",function(){console.log("Disconnect"),i.leave(r.docId),r.onDisconnect(i),(i.manager&&0===i.manager.sockets.clients(r.docId).length||i.ns&&0===Object.keys(i.ns.connected).length)&&r.emit("empty-room")})},EditorSocketIOServer.prototype.onOperation=function(t,e,o,n){var i;try{i=new WrappedOperation(TextOperation.fromJSON(o),n&&Selection.fromJSON(n))}catch(t){return void console.error("Invalid operation received: "+t)}try{var r=t.id,s=this.receiveOperation(e,i);console.log("client: "+this.getClient(r).name+" new operation: "+i.wrapped),this.getClient(r).selection=s.meta,t.emit("ack"),t.broadcast.in(this.docId).emit("operation",r,s.wrapped.toJSON(),s.meta)}catch(t){console.error(t)}},EditorSocketIOServer.prototype.updateSelection=function(t,e){var o=t.id;e?this.getClient(o).selection=e:delete this.getClient(o).selection,t.broadcast.in(this.docId).emit("selection",o,e)},EditorSocketIOServer.prototype.setName=function(t,e){var o=t.id;this.getClient(o).name=e,t.broadcast.in(this.docId).emit("set_name",o,e)},EditorSocketIOServer.prototype.getClient=function(t){return this.users[t]||(this.users[t]={})},EditorSocketIOServer.prototype.onDisconnect=function(t){var e=t.id;delete this.users[e],t.broadcast.in(this.docId).emit("client_left",e)},module.exports=EditorSocketIOServer,void 0===ot&&(ot={}),ot.SimpleTextOperation=function(t){var r=t.ot?t.ot.TextOperation:require("./text-operation");function o(){}function s(t,e){if(!this||this.constructor!==o)return new s(t,e);this.str=t,this.position=e}function p(t,e){if(!this||this.constructor!==o)return new p(t,e);this.count=t,this.position=e}function n(){if(!this||this.constructor!==o)return new n}s.prototype=new o,(o.Insert=s).prototype.toString=function(){return"Insert("+JSON.stringify(this.str)+", "+this.position+")"},s.prototype.equals=function(t){return t instanceof s&&this.str===t.str&&this.position===t.position},s.prototype.apply=function(t){return t.slice(0,this.position)+this.str+t.slice(this.position)},p.prototype=new o,(o.Delete=p).prototype.toString=function(){return"Delete("+this.count+", "+this.position+")"},p.prototype.equals=function(t){return t instanceof p&&this.count===t.count&&this.position===t.position},p.prototype.apply=function(t){return t.slice(0,this.position)+t.slice(this.position+this.count)},n.prototype=new o,(o.Noop=n).prototype.toString=function(){return"Noop()"},n.prototype.equals=function(t){return t instanceof n},n.prototype.apply=function(t){return t};var i=new n;return o.transform=function(t,e){if(t instanceof n||e instanceof n)return[t,e];if(t instanceof s&&e instanceof s)return t.position<e.position||t.position===e.position&&t.str<e.str?[t,new s(e.str,e.position+t.str.length)]:t.position>e.position||t.position===e.position&&t.str>e.str?[new s(t.str,t.position+e.str.length),e]:[i,i];if(t instanceof s&&e instanceof p)return t.position<=e.position?[t,new p(e.count,e.position+t.str.length)]:t.position>=e.position+e.count?[new s(t.str,t.position-e.count),e]:[i,new p(e.count+t.str.length,e.position)];if(t instanceof p&&e instanceof s)return t.position>=e.position?[new p(t.count,t.position+e.str.length),e]:t.position+t.count<=e.position?[t,new s(e.str,e.position-t.count)]:[new p(t.count+e.str.length,t.position),i];if(t instanceof p&&e instanceof p){if(t.position===e.position)return t.count===e.count?[i,i]:t.count<e.count?[i,new p(e.count-t.count,e.position)]:[new p(t.count-e.count,t.position),i];if(t.position<e.position)return t.position+t.count<=e.position?[t,new p(e.count,e.position-t.count)]:t.position+t.count>=e.position+e.count?[new p(t.count-e.count,t.position),i]:[new p(e.position-t.position,t.position),new p(e.position+e.count-(t.position+t.count),t.position)];if(t.position>e.position)return t.position>=e.position+e.count?[new p(t.count,t.position-e.count),e]:t.position+t.count<=e.position+e.count?[i,new p(e.count-t.count,e.position)]:[new p(t.position+t.count-(e.position+e.count),e.position),new p(t.position-e.position,e.position)]}},o.fromTextOperation=function(t){for(var e=[],o=0,n=0;n<t.ops.length;n++){var i=t.ops[n];r.isRetain(i)?o+=i:r.isInsert(i)?(e.push(new s(i,o)),o+=i.length):e.push(new p(Math.abs(i),o))}return e},o}(this),"object"==typeof module&&(module.exports=ot.SimpleTextOperation),void 0===ot&&(ot={}),ot.Server=function(){"use strict";function t(t,e){this.document=t,this.operations=e||[]}return t.prototype.receiveOperation=function(t,e){if(t<0||this.operations.length<t)throw new Error("operation revision not in history");for(var o=this.operations.slice(t),n=e.constructor.transform,i=0;i<o.length;i++)e=n(e,o[i])[0];return this.document=e.apply(this.document),this.operations.push(e),e},t}(),"object"==typeof module&&(module.exports=ot.Server);